<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <!-- CSP temporarily disabled for Stripe.js compatibility -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://js.stripe.com https://api.stripe.com https://hooks.stripe.com https://checkout.stripe.com https://fonts.googleapis.com https://fonts.gstatic.com https://api.openai.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://api.stripe.com https://hooks.stripe.com https://checkout.stripe.com https://replit.com blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://api.stripe.com https://hooks.stripe.com https://checkout.stripe.com https://api.openai.com ws: wss:; frame-src 'self' https://js.stripe.com https://hooks.stripe.com https://checkout.stripe.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com;"> -->
    <title>Adaptalyfe - Grow with Guidance. Thrive with Confidence.</title>
    <link rel="stylesheet" href="/force-hide-errors.css">
    <script src="/block-error-modal.js?v=2"></script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="Adaptalyfe - Grow with Guidance. Thrive with Confidence. Helping individuals with developmental disabilities build independence through daily task management, financial planning, mood tracking, and comprehensive support features." />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#22c55e" />
    <link rel="icon" href="/icon-192.png" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Adaptalyfe" />
    
    <!-- Mobile Debug Script -->
    <script>
      // Mobile debugging
      window.addEventListener('error', function(e) {
        console.error('Mobile Error:', e.error, e.filename, e.lineno);
        document.body.innerHTML = '<div style="padding:20px;font-family:Arial;color:red;"><h2>Mobile Error Detected</h2><p>Error: ' + e.error + '</p><p>File: ' + e.filename + '</p><p>Line: ' + e.lineno + '</p></div>';
      });
      
      // Log mobile detection
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      console.log('Mobile detected:', isMobile, 'User agent:', navigator.userAgent);
      
      // Login redirect fix
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'LOGIN_SUCCESS') {
          console.log('Login success detected, redirecting to dashboard...');
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 500);
        }
      });
      
      // Manual login success detection
      let checkLoginSuccess = setInterval(function() {
        if (window.location.pathname === '/login' && document.querySelector('[data-login-success]')) {
          console.log('Manual redirect to dashboard after login success');
          clearInterval(checkLoginSuccess);
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 1000);
        }
      }, 500);
      
      // Global login success handler for React components
      window.handleLoginSuccess = function(response) {
        console.log('Global login success handler triggered', response);
        if (response && response.success) {
          const redirectUrl = response.redirect || '/dashboard';
          console.log('Redirecting to:', redirectUrl);
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 500);
        }
      };
      
      // Enhanced fetch debugging with network error handling
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        console.log('üîç Fetch intercepted:', args[0]);
        
        // Ensure fetch options include credentials
        const options = args[1] || {};
        if (!options.credentials) {
          options.credentials = 'include';
        }
        args[1] = options;
        
        console.log('üîç Fetch options (with credentials):', args[1]);
        
        return originalFetch.apply(this, args).then(response => {
          console.log('üîç Raw response object:', response);
          console.log('‚úÖ Fetch response received:', {
            url: response.url, 
            status: response.status, 
            ok: response.ok,
            headers: [...response.headers.entries()]
          });
          
          if (response.url && response.url.includes('/api/auth/login')) {
            console.log('üîê Login endpoint detected, status:', response.status);
            if (response.ok) {
              response.clone().json().then(data => {
                console.log('üìù Login response data:', data);
                if (data.success) {
                  console.log('üöÄ Login API success detected, triggering redirect');
                  window.handleLoginSuccess(data);
                }
              }).catch(err => {
                console.error('‚ùå Error parsing login response:', err);
              });
            } else {
              console.error('‚ùå Login API failed with status:', response.status);
              response.clone().text().then(text => {
                console.error('‚ùå Error response body:', text);
              });
            }
          }
          return response;
        }).catch(err => {
          console.error('‚ùå FETCH ERROR - Network failure:', err);
          console.error('‚ùå URL attempted:', args[0]);
          console.error('‚ùå Error type:', err.name);
          console.error('‚ùå Error message:', err.message);
          
          // Show user-friendly error
          if (err.message.includes('fetch')) {
            alert('Network error: Cannot connect to server. Please check your internet connection and try again.');
          }
          
          throw err;
        });
      };
      
      // Force redirect button for debugging
      setTimeout(() => {
        if (window.location.pathname === '/login') {
          const debugBtn = document.createElement('button');
          debugBtn.innerHTML = 'DEBUG: Force Dashboard';
          debugBtn.style.cssText = 'position:fixed;top:10px;right:10px;z-index:9999;background:red;color:white;padding:10px;border:none;cursor:pointer;';
          debugBtn.onclick = () => {
            console.log('Force redirect to dashboard');
            window.location.href = '/dashboard';
          };
          document.body.appendChild(debugBtn);
          
          // Add native form login bypass
          const nativeBtn = document.createElement('button');
          nativeBtn.innerHTML = 'NATIVE LOGIN';
          nativeBtn.style.cssText = 'position:fixed;top:10px;left:10px;z-index:9999;background:blue;color:white;padding:10px;border:none;cursor:pointer;';
          nativeBtn.onclick = () => {
            console.log('Attempting native form login...');
            
            // Create form dynamically
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/api/auth/login';
            form.style.display = 'none';
            
            const usernameInput = document.createElement('input');
            usernameInput.type = 'hidden';
            usernameInput.name = 'username';
            usernameInput.value = 'demo';
            
            const passwordInput = document.createElement('input');
            passwordInput.type = 'hidden';
            passwordInput.name = 'password';
            passwordInput.value = 'password123';
            
            form.appendChild(usernameInput);
            form.appendChild(passwordInput);
            document.body.appendChild(form);
            
            // Submit form
            form.submit();
          };
          document.body.appendChild(nativeBtn);
          
          // Add API test button
          const testBtn = document.createElement('button');
          testBtn.innerHTML = 'TEST API';
          testBtn.style.cssText = 'position:fixed;top:60px;left:10px;z-index:9999;background:green;color:white;padding:10px;border:none;cursor:pointer;';
          testBtn.onclick = async () => {
            console.log('Testing API endpoints...');
            
            // Test health endpoint
            try {
              const healthResponse = await fetch('/health');
              console.log('Health endpoint status:', healthResponse.status);
              console.log('Health endpoint response:', await healthResponse.json());
            } catch (error) {
              console.error('Health endpoint failed:', error);
            }
            
            // Test login endpoint with fetch
            try {
              const loginResponse = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                  username: 'demo',
                  password: 'password123'
                })
              });
              console.log('Login endpoint status:', loginResponse.status);
              console.log('Login endpoint response:', await loginResponse.json());
              
              if (loginResponse.ok) {
                console.log('Login successful, redirecting...');
                window.location.href = '/dashboard';
              }
            } catch (error) {
              console.error('Login endpoint failed:', error);
              alert('API Test Failed: ' + error.message);
            }
          };
          document.body.appendChild(testBtn);
          
          // Add Dashboard Debug Button
          const dashBtn = document.createElement('button');
          dashBtn.innerHTML = 'DEBUG DASHBOARD';
          dashBtn.style.cssText = 'position:fixed;top:110px;left:10px;z-index:9999;background:purple;color:white;padding:10px;border:none;cursor:pointer;';
          dashBtn.onclick = async () => {
            console.log('Testing dashboard API...');
            
            try {
              const dashResponse = await fetch('/api/dashboard', {
                credentials: 'include'
              });
              console.log('Dashboard API status:', dashResponse.status);
              const dashData = await dashResponse.json();
              console.log('Dashboard API response:', dashData);
              
              // Check for quick actions in the response
              if (dashData.quickActions) {
                console.log('‚úÖ Quick Actions found in API:', dashData.quickActions.length, 'items');
                dashData.quickActions.forEach((action, i) => {
                  console.log(`Quick Action ${i+1}:`, action);
                });
                
                // Try to render quick actions directly in DOM for testing
                const quickActionsContainer = document.querySelector('[data-testid="quick-actions"]') || 
                                            document.querySelector('.quick-actions') ||
                                            document.querySelector('#quick-actions');
                                            
                if (quickActionsContainer) {
                  console.log('‚úÖ Found quick actions container in DOM');
                } else {
                  console.log('‚ùå No quick actions container found in DOM');
                  
                  // Check if we're on dashboard and inject quick actions HTML for testing
                  if (window.location.pathname === '/dashboard') {
                    console.log('üîß Injecting test quick actions HTML...');
                    const testHTML = `
                      <div style="background: white; padding: 20px; margin: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 15px;">Quick Actions (Debug)</h3>
                        ${dashData.quickActions.map(action => `
                          <div style="display: inline-block; background: ${action.completed ? '#dcfce7' : '#fef3c7'}; padding: 12px; margin: 8px; border-radius: 6px; border: 1px solid ${action.completed ? '#16a34a' : '#f59e0b'}; cursor: pointer;">
                            <div style="font-weight: bold; color: #333;">${action.title}</div>
                            <div style="font-size: 12px; color: #666;">${action.category} ‚Ä¢ ${action.completed ? '‚úÖ Done' : '‚è≥ Pending'}</div>
                          </div>
                        `).join('')}
                      </div>
                    `;
                    
                    const quickActionsSection = document.querySelector('h2');
                    if (quickActionsSection && quickActionsSection.textContent === 'Quick Actions') {
                      quickActionsSection.insertAdjacentHTML('afterend', testHTML);
                      console.log('‚úÖ Test quick actions HTML injected');
                    } else {
                      document.body.insertAdjacentHTML('beforeend', testHTML);
                      console.log('‚úÖ Test quick actions HTML added to body');
                    }
                  }
                }
              } else {
                console.log('‚ùå No quickActions in response');
              }
              
              // Check for customization in the response
              if (dashData.customization) {
                console.log('‚úÖ Customization found in API:', dashData.customization);
              } else {
                console.log('‚ùå No customization in response');
              }
              
              alert('Dashboard API Test Complete - Check console for details');
              
            } catch (error) {
              console.error('Dashboard API failed:', error);
              alert('Dashboard API Test Failed: ' + error.message);
            }
          };
          document.body.appendChild(dashBtn);
        }
      }, 2000);
      
      // Service Worker Registration (commented out for mobile debugging)
      /*
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }
      */
    </script>
    <script type="module" crossorigin src="/assets/index-CdgTcnaq.js"></script>
    <script src="/debug-inject.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-BpAM9bFg.css">
  </head>
  <body>
    <div id="root"></div>
    <!-- This is a replit script which adds a banner on the top of the page when opened in development mode outside the replit environment -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
  </body>
</html>